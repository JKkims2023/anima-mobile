/**
 * ğŸ”® TarotGameView - Tarot Fortune Telling Game
 * 
 * Features:
 * - Persona background (video/image with dark overlay)
 * - Non-cumulative chat (reset on each phase)
 * - Card grid overlay (8 cards, 2x4 layout)
 * - LLM-powered tarot reading
 * - Daily limit integration
 * 
 * Privacy:
 * - Does NOT save game results (user_question, cards, interpretation)
 * - Only tracks play count for daily limit
 * 
 * Phases:
 * 1. greeting: Initial welcome message
 * 2. question: User asks a question
 * 3. selection: User selects 3 cards from 8
 * 4. reveal: Cards flip sequentially
 * 5. interpretation: LLM provides reading
 * 6. end: Game complete (no save to DB!)
 * 
 * @author JK & Hero NEXUS
 * @version 1.0.0 - Basic Structure (MVP)
 * @date 2026-01-23
 */

import React, { useState, useEffect, useCallback, useRef } from 'react';
import {
  View,
  Modal,
  StyleSheet,
  TouchableOpacity,
  Platform,
  StatusBar,
  ImageBackground,
  Dimensions,
  Keyboard,
  KeyboardAvoidingView,
  ScrollView,
  FlatList,
  TouchableWithoutFeedback,
  Animated as RNAnimated,
} from 'react-native';
import { useSafeAreaInsets } from 'react-native-safe-area-context';
import Animated, {
  useSharedValue,
  useAnimatedStyle,
  withTiming,
  withDelay,
  Easing,
} from 'react-native-reanimated';
import Video from 'react-native-video';
import Icon from 'react-native-vector-icons/Ionicons';
import CustomText from '../CustomText';
import TarotInputBar from '../chat/TarotInputBar'; // ğŸ”® For question input
import TarotCard from './TarotCard'; // ğŸ´ Tarot card component
import TarotBubble from './TarotBubble'; // ğŸ’¬ NEW: Tarot chat bubble
import HapticService from '../../utils/HapticService';
import { scale, moderateScale, verticalScale, platformPadding } from '../../utils/responsive-utils';
import { useTheme } from '../../contexts/ThemeContext';
import { COLORS } from '../../styles/commonstyles';

// ğŸ´ Tarot Cards Data
import TAROT_CARDS from '../../data/tarotCards.json';

const { width: SCREEN_WIDTH, height: SCREEN_HEIGHT } = Dimensions.get('window');


/**
 * CardWrapper - Fade out animation for unselected cards
 */
const CardWrapper = ({ children, isTransitioning, isSelected }) => {
  const opacity = useSharedValue(1);
  const scale = useSharedValue(1);
  
  useEffect(() => {
    if (isTransitioning && !isSelected) {
      // âœ¨ Fade out unselected cards
      opacity.value = withTiming(0, {
        duration: 600,
        easing: Easing.out(Easing.ease),
      });
      scale.value = withTiming(0.8, {
        duration: 600,
        easing: Easing.out(Easing.ease),
      });
    }
  }, [isTransitioning, isSelected]);
  
  const animatedStyle = useAnimatedStyle(() => ({
    opacity: opacity.value,
    transform: [{ scale: scale.value }],
  }));
  
  return (
    <Animated.View style={[styles.cardWrapper, animatedStyle]}>
      {children}
    </Animated.View>
  );
};

/**
 * TarotGameView Component
 * 
 * @param {boolean} visible - Modal visibility
 * @param {function} onClose - Close callback
 * @param {function} onLimitClose - Limit reached callback (tier upgrade)
 * @param {object} persona - Selected persona object
 * @param {object} user - User object
 */
const TarotGameView = ({
  visible,
  onClose,
  onLimitClose,
  persona,
  user,
}) => {
  const insets = useSafeAreaInsets();
  const { currentTheme } = useTheme();
  const refFirstLoad = useRef(false);
  
  // âœ… Game Phase State
  const [gamePhase, setGamePhase] = useState('greeting');
  // 'greeting' | 'question' | 'selection' | 'reveal' | 'interpretation' | 'end'
  
  // âœ… Messages State (For Phase 5: Interpretation)
  const [messages, setMessages] = useState([]);
  
  // âœ… User Input State
  const [userQuestion, setUserQuestion] = useState('');
  
  // âœ… Cards State (Phase 3: Selection)
  const [availableCards, setAvailableCards] = useState([]); // 8ì¥ ëœë¤
  const [selectedCards, setSelectedCards] = useState([]); // ìµœëŒ€ 3ì¥
  const [revealedCards, setRevealedCards] = useState([]); // Flipëœ ì¹´ë“œ
  
  // âœ… Animation State (Phase 3 â†’ 4 Transition)
  const [isTransitioning, setIsTransitioning] = useState(false);
  
  // âœ… Bubble State (Left/Right)
  const [personaBubbleMessage, setPersonaBubbleMessage] = useState('');
  const [userBubbleMessage, setUserBubbleMessage] = useState('');
  const [showPersonaBubble, setShowPersonaBubble] = useState(false);
  const [showUserBubble, setShowUserBubble] = useState(false);
  
  // âœ… Card Selection Button State
  const [showCardSelectButton, setShowCardSelectButton] = useState(false);
  
  // âœ… UI State
  const [isLoading, setIsLoading] = useState(false);

  const keyboardHeight = useRef(new RNAnimated.Value(0)).current;
  
  const dismissKeyboard = () => {
    Keyboard.dismiss();
  };

  // âœ… Debug: Log when component mounts/unmounts
  useEffect(() => {
    if (visible) {
      console.log('ğŸ”® [TarotGameView] Component mounted');
      console.log('   Persona:', persona?.persona_name);
      console.log('   User:', user?.user_key);
      console.log(persona);
      HapticService.medium();
      refFirstLoad.current = true;
    }
    
    return () => {
      if (visible) {
        console.log('ğŸ”® [TarotGameView] Component unmounting');
      }
      refFirstLoad.current = false;
    };
  }, [visible, persona, user, refFirstLoad]);
  
  // âœ… Initialize game on mount (Phase 1: Greeting)
  useEffect(() => {
    if (visible) {
      setGamePhase('greeting');

      refFirstLoad.current = true;
      
      // â­ Show initial greeting in left bubble (Persona)
      const greetingMessage = `ì•ˆë…•! ì˜¤ëŠ˜ì€ ë¬´ì—‡ì´ ê¶ê¸ˆí•´? ğŸ”®`;
      setPersonaBubbleMessage(greetingMessage);
      setShowPersonaBubble(true);
      
      console.log('ğŸ”® [TarotGameView] Initialized - Phase: greeting');
    }else{
      refFirstLoad.current = true;
    }
  }, [visible, refFirstLoad]);


  // âœ… Keyboard Event Listeners (ê°€ì¥ ì¤‘ìš”í•©ë‹ˆë‹¤!)
  useEffect(() => {
    // âœ¨ 1. iOSëŠ” 'Will' ì´ë²¤íŠ¸ë¥¼, AndroidëŠ” 'Did' ì´ë²¤íŠ¸ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ë¶„ê¸°í•©ë‹ˆë‹¤.
    const showEvent = Platform.OS === 'ios' ? 'keyboardWillShow' : 'keyboardDidShow';
    const hideEvent = Platform.OS === 'ios' ? 'keyboardWillHide' : 'keyboardDidHide';

    const keyboardShowListener = Keyboard.addListener(
      showEvent,
      (e) => {
        // e.endCoordinates.heightëŠ” iOSì™€ Android ëª¨ë‘ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
        const keyboardTop = e.endCoordinates.height;
        console.log(`âŒ¨ï¸ Keyboard SHOW event (${showEvent}), height:`, keyboardTop);
        
      refFirstLoad.current = false;
        // âœ¨ 2. iOSì™€ Android ëª¨ë‘ì—ê²Œ ë™ì¼í•œ ë¡œì§ì„ ì ìš©í•©ë‹ˆë‹¤.
        //    'e.duration' ê°’ì„ ì‚¬ìš©í•˜ì—¬ ì‹¤ì œ í‚¤ë³´ë“œ ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„ê³¼ ë˜‘ê°™ì´ ë™ê¸°í™”í•©ë‹ˆë‹¤.
        RNAnimated.timing(keyboardHeight, {
          toValue: Platform.OS === 'ios' ? keyboardTop - scale(35) : scale(-50),
          duration: 0 || 250, // ì´ë²¤íŠ¸ì— durationì´ ì—†ìœ¼ë©´ 250ms ì‚¬ìš©
          useNativeDriver: false,
        }).start();
      }
    );

    const keyboardHideListener = Keyboard.addListener(
      hideEvent,
      (e) => {
        console.log(`âŒ¨ï¸ Keyboard HIDE event (${hideEvent})`);
        
        RNAnimated.timing(keyboardHeight, {
          toValue: Platform.OS === 'ios' ? 0 : scale(-50), // 0ìœ¼ë¡œ ë˜ëŒë¦½ë‹ˆë‹¤.
          duration: Platform.OS === 'ios' ? 0 : 250,
          useNativeDriver: false,
        }).start();
      }
    );

    return () => {
      keyboardShowListener.remove();
      keyboardHideListener.remove();
    };
  }, [keyboardHeight]);

  
  // âœ… Handle Close
  const handleClose = useCallback(() => {
    console.log('ğŸ”® [TarotGameView] Close button pressed');
    HapticService.light();
    
    // Reset all state
    setGamePhase('greeting');
    setMessages([]);
    setUserQuestion('');
    setAvailableCards([]);
    setSelectedCards([]);
    setRevealedCards([]);
    setIsTransitioning(false);
    
    // Reset bubble state
    setPersonaBubbleMessage('');
    setUserBubbleMessage('');
    setShowPersonaBubble(false);
    setShowUserBubble(false);
    setShowCardSelectButton(false);
    
    // Call parent close
    onClose();
  }, [onClose]);
  
  // âœ… Handle Send (Phase 2: Question) - New Bubble Process
  const handleSend = useCallback((text) => {
    if (!text.trim()) return;
    
    console.log('ğŸ”® [TarotGameView] User question:', text);
    HapticService.light();  
    Keyboard.dismiss();
    
    // Save user question
    setUserQuestion(text);
    
    // Transition to Phase 2 (Question)
    setGamePhase('question');
    
    // Step 1: Show user bubble (right)
    setUserBubbleMessage(text);
    setShowUserBubble(true);
    setShowPersonaBubble(false);
    
    // Step 2: Hide user bubble, show persona bubble (left) after 1s
    setTimeout(() => {
      setShowUserBubble(false);
      
      const personaResponse = "ì•Œì•˜ì–´! ê·¸ëŸ¼ ì¹´ë“œë¥¼ 3ì¥ ì„ íƒí•´ë´ ğŸ´âœ¨";
      setPersonaBubbleMessage(personaResponse);
      setShowPersonaBubble(true);
      
      // Step 3: Show "ì¹´ë“œ ì„ íƒí•˜ê¸°" button after 2s
      setTimeout(() => {
        setShowCardSelectButton(true);
        console.log('ğŸ”® [TarotGameView] Card select button shown');
      }, 2000);
    }, 1000);
  }, []);
  
  // âœ… Handle Card Select Button Click
  const handleCardSelectButtonClick = useCallback(() => {
    console.log('ğŸ´ [TarotGameView] Card select button clicked');
    HapticService.medium();
    
    // Hide button and persona bubble
    setShowCardSelectButton(false);
    setShowPersonaBubble(false);
    
    // Transition to Phase 3 (Selection)
    setGamePhase('selection');
    console.log('ğŸ”® [TarotGameView] Phase changed: question â†’ selection');
    
    // Initialize 9 random cards
    initializeCards();
  }, []);
  
  // âœ… Initialize Cards (Phase 3: Selection)
  const initializeCards = useCallback(() => {
    console.log('ğŸ´ [TarotGameView] Initializing 9 random cards...');
    
    // Shuffle and select 9 cards (3x3 layout)
    const shuffled = [...TAROT_CARDS].sort(() => Math.random() - 0.5);
    const selected = shuffled.slice(0, 9);
    
    setAvailableCards(selected);
    setSelectedCards([]);
    setRevealedCards([]);
    
    console.log('ğŸ´ [TarotGameView] Cards initialized:', selected.map(c => c.name_ko));
  }, []);
  
  // âœ… Handle Confirm Selection (Phase 3 â†’ 4)
  const handleConfirmSelection = useCallback(() => {
    if (selectedCards.length !== 3) {
      console.log('ğŸ´ [TarotGameView] Must select exactly 3 cards!');
      HapticService.error();
      return;
    }
    
    console.log('ğŸ´ [TarotGameView] Selection confirmed! Cards:', selectedCards.map(c => c.name_ko));
    console.log('âœ¨ [TarotGameView] Starting transition animation...');
    HapticService.medium();
    
    // âœ¨ Step 1: Start transition (fade out unselected cards)
    setIsTransitioning(true);
    
    // âœ¨ Step 2: After fade out, transition to Phase 4 (Reveal)
    setTimeout(() => {
      setGamePhase('reveal');
      setRevealedCards([]); // Reset revealed cards
      setIsTransitioning(false);
      console.log('ğŸ”® [TarotGameView] Phase changed: selection â†’ reveal');
    }, 800); // 0.8s fade out duration
  }, [selectedCards]);
  
  // âœ… Handle Card Select (Phase 3: Selection)
  const handleCardSelect = useCallback((card) => {
    console.log('ğŸ´ [TarotGameView] Card selected:', card.name_ko);
    HapticService.light();
    
    setSelectedCards(prev => {
      // Already selected? Deselect
      if (prev.some(c => c.id === card.id)) {
        console.log('   â†’ Deselecting card');
        return prev.filter(c => c.id !== card.id);
      }
      
      // Max 3 cards
      if (prev.length >= 3) {
        console.log('   â†’ Already 3 cards selected!');
        HapticService.error();
        return prev;
      }
      
      // Add card
      console.log('   â†’ Adding card');
      return [...prev, card];
    });
  }, []);
  
  // âœ… Card Flip Animation (Phase 4: Reveal)
  useEffect(() => {
    if (gamePhase === 'reveal' && selectedCards.length === 3) {
      console.log('ğŸ´ [TarotGameView] Starting card flip animation...');
      
      // Flip cards sequentially (0.8s interval)
      const flipCard = (index) => {
        setTimeout(() => {
          const cardId = selectedCards[index].id;
          console.log(`   â†’ Flipping card ${index + 1}: ${selectedCards[index].name_ko}`);
          
          setRevealedCards(prev => [...prev, cardId]);
          HapticService.light();
          
          // If last card, transition to Phase 5 (Interpretation)
          if (index === 2) {
            setTimeout(() => {
              console.log('ğŸ”® [TarotGameView] All cards revealed! Phase changed: reveal â†’ interpretation');
              setGamePhase('interpretation');
              
              // TODO: Call LLM for tarot interpretation
              generateInterpretation();
            }, 1000); // Wait 1s after last flip
          }
        }, index * 800); // 0.8s interval
      };
      
      // Start flipping
      flipCard(0);
      flipCard(1);
      flipCard(2);
    }
  }, [gamePhase, selectedCards]);
  
  // âœ… Generate Tarot Interpretation (Phase 5: Interpretation)
  const generateInterpretation = useCallback(async () => {
    console.log('ğŸ”® [TarotGameView] Generating tarot interpretation...');
    setIsLoading(true);
    
    try {
      // TODO: Call LLM API for interpretation
      // For now, simulate with timeout
      setTimeout(() => {
        const interpretationText = `${persona?.persona_name || 'íƒ€ë¡œ ë§ˆìŠ¤í„°'}ì˜ í•´ì„:\n\n` +
          `ê³¼ê±°(${selectedCards[0]?.name_ko}): ê³¼ê±°ì˜ ê²½í—˜ì´ ì§€ê¸ˆì˜ ë„ˆë¥¼ ë§Œë“¤ì—ˆì–´.\n\n` +
          `í˜„ì¬(${selectedCards[1]?.name_ko}): ì§€ê¸ˆì€ ìƒˆë¡œìš´ ë³€í™”ì˜ ì‹œê¸°ì•¼.\n\n` +
          `ë¯¸ë˜(${selectedCards[2]?.name_ko}): ë°ì€ ë¯¸ë˜ê°€ ê¸°ë‹¤ë¦¬ê³  ìˆì–´! âœ¨`;
        
        setMessages([
          {
            id: 'interpretation_1',
            type: 'ai',
            text: interpretationText,
            timestamp: Date.now(),
          }
        ]);
        
        setIsLoading(false);
        console.log('ğŸ”® [TarotGameView] Interpretation generated!');
      }, 2000);
    } catch (error) {
      console.error('ğŸ”® [TarotGameView] Interpretation error:', error);
      setIsLoading(false);
    }
  }, [selectedCards, persona]);
  
  // âœ… Determine background source
  const hasVideo = persona?.selected_dress_video_url && 
                   persona?.selected_dress_video_convert_done === 'Y';
  const backgroundImageUrl = persona?.selected_dress_image_url || 
                             persona?.persona_image_url || 
                             persona?.original_url;
  
  // âœ… Debug: Log background info
  useEffect(() => {
    if (visible) {
      console.log('ğŸ”® [TarotGameView] Background Info:');
      console.log('   Has Video:', hasVideo);
      console.log('   Video URL:', persona?.selected_dress_video_url?.substring(0, 50));
      console.log('   Image URL:', backgroundImageUrl?.substring(0, 50));
    }
  }, [visible, hasVideo, persona, backgroundImageUrl]);
  
  return (
    <Modal
      visible={visible}
      animationType="fade"
      transparent={true}
      onRequestClose={handleClose}
//      statusBarTranslucent={true}
    >

      
      {/* âœ… Background Container (Full Screen) */}
      <View style={styles.container}>
        {/* Background: Video or Image (FULL SCREEN, NO OVERLAY!) */}
        {hasVideo ? (
          <Video
            source={{ uri: 'https://babi-cdn.logbrix.ai/babi/real/babi/47efe62b-109f-419f-8484-3ac175cabccf_00001_.mp4' }}
            style={[styles.background, { marginTop: Platform.OS === 'ios' ? 0 : 0,

             }]}
            resizeMode="contain"
            repeat={true}
            muted={true}
            playInBackground={false}
            playWhenInactive={false}
            onError={(error) => {
              console.error('ğŸ”® [TarotGameView] Video error:', error);
            }}
          />
        ) : (
          <ImageBackground
            source={{ uri: 'https://babi-cdn.logbrix.ai/babi/real/babi/e832b7d9-4ff2-41f1-8c5f-0b08b055fe9d_00001_.png' }}
            style={styles.background}
            resizeMode="contain"
            imageStyle={{ width: SCREEN_WIDTH, height: SCREEN_HEIGHT }}
          />
        )}
        
        {/* âœ… Content Container (Respects Safe Area) */}
        <View style={styles.contentWrapper}> 
          <View style={[styles.content, { paddingTop: insets.top, paddingBottom: insets.bottom }]}>
            {/* âœ… Header (Below System Area) */}
            <View style={styles.header}>
              {/* Back Button */}
              <TouchableOpacity
                onPress={handleClose}
                style={styles.backButton}
                hitSlop={{ top: 10, bottom: 10, left: 10, right: 10 }}
              >
                <Icon name="chevron-back" size={moderateScale(28)} color="#FFF" />
              </TouchableOpacity>
              
              {/* Persona Name */}
              <View style={styles.headerCenter}>
                <CustomText type="title" bold style={styles.headerTitle}>
                  ğŸ”® {persona?.persona_name || 'Tarot Master'}
                </CustomText>
              </View>
              
              {/* Help Button (Placeholder) */}
              <TouchableOpacity
                style={styles.helpButton}
                onPress={() => {
                  console.log('ğŸ”® [TarotGameView] Help button pressed');
                  HapticService.light();
                  // TODO: Open help modal
                }}
                hitSlop={{ top: 10, bottom: 10, left: 10, right: 10 }}
              >
                <Icon name="help-circle-outline" size={moderateScale(28)} color="#FFF" />
              </TouchableOpacity>
            </View>
            
            {/* âœ¨ Chat Bubbles (Left: Persona, Right: User) */}
            <TarotBubble
              position="left"
              message={personaBubbleMessage}
              visible={showPersonaBubble}
            />
            <TarotBubble
              position="right"
              message={userBubbleMessage}
              visible={showUserBubble}
            />
            <TouchableWithoutFeedback onPress={dismissKeyboard}>
            {/* âœ… Main Content Area (flex: 1) */}
            <View style={styles.mainContentArea}>
              {/* Phase 1, 2: Empty (bubbles only) */}
              {/* âœ¨ Card Select Button (Phase 2: Question - after persona response) */}
              {gamePhase === 'question' && showCardSelectButton && (
                <View style={styles.cardSelectButtonContainer}>
                  <TouchableOpacity
                    style={styles.cardSelectButton}
                    onPress={handleCardSelectButtonClick}
                    activeOpacity={0.8}
                  >
                    <CustomText type="title" style={styles.cardSelectButtonText}>
                      ğŸ”® ì¹´ë“œ ì„ íƒí•˜ê¸°
                    </CustomText>
                  </TouchableOpacity>
                </View>
              )}
              
              {/* Card Selection Area (Phase 3: Selection) */}
              {gamePhase === 'selection' && (
                <View style={styles.cardSelectionContainer}>
                  {/* Card Grid (3x3) - ìˆœì°¨ì  ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ âœ¨ */}
                  <FlatList
                    data={availableCards}
                    keyExtractor={(item) => item.id.toString()}
                    numColumns={3}
                    scrollEnabled={false}
                    contentContainerStyle={styles.cardGrid}
                    renderItem={({ item, index }) => {
                      const isCardSelected = selectedCards.some(c => c.id === item.id);
                      
                      return (
                        <CardWrapper
                          key={item.id}
                          isTransitioning={isTransitioning}
                          isSelected={isCardSelected}
                        >
                          <TarotCard
                            card={item}
                            isFront={false}
                            isSelected={isCardSelected}
                            onPress={() => handleCardSelect(item)}
                            disabled={isTransitioning}
                            delay={index * 150} // âœ¨ ìˆœì°¨ì  ë“±ì¥ (0.15ì´ˆ ê°„ê²©, ë” ì‹ ë¹„ë¡­ê²Œ!)
                          />
                        </CardWrapper>
                      );
                    }}
                  />
                  
                  {/* âœ… Confirm Button (ê¸°ì¡´ êµ¬ì¡° ë³µì›) */}
                  <TouchableOpacity
                    style={[
                      styles.confirmButton,
                      {display: selectedCards.length === 3 ? 'flex' : 'none'}
                     // selectedCards.length !== 3 && styles.confirmButtonDisabled
                    ]}
                    onPress={handleConfirmSelection}
                    disabled={selectedCards.length !== 3}
                    activeOpacity={0.8}
                  >
                    <CustomText type="middle" bold style={styles.confirmButtonText}>
                      {selectedCards.length === 3 
                        ? 'âœ¨ ìš´ëª… í™•ì¸í•˜ê¸° âœ¨' 
                        : `ë§ˆìŒì´ ì´ë„ëŠ” ëŒ€ë¡œ ì„ íƒí•˜ì„¸ìš” (${selectedCards.length}/3)`}
                    </CustomText>
                  </TouchableOpacity>
                </View>
              )}
              
              {/* Card Reveal Area (Phase 4: Reveal) */}
              {gamePhase === 'reveal' && (
                <View style={styles.revealContainer}>
                  {/* Title */}
                  <View style={styles.revealTitleContainer}>
                    <CustomText type="title" bold style={styles.revealTitle}>
                      ğŸ”® ìš´ëª…ì˜ ì¹´ë“œ ğŸ”®
                    </CustomText>
                    <CustomText type="small" style={styles.revealSubtitle}>
                      ì„ íƒí•œ ì¹´ë“œë¥¼ ê³µê°œí•©ë‹ˆë‹¤...
                    </CustomText>
                  </View>
                  
                  {/* 3 Cards in a Row */}
                  <View style={styles.revealCardsContainer}>
                    {selectedCards.map((card, index) => (
                      <View key={card.id} style={styles.revealCardWrapper}>
                        <TarotCard
                          card={card}
                          isFront={revealedCards.includes(card.id)}
                          isSelected={false}
                          disabled={true}
                        />
                        {/* Card Position Label */}
                        <CustomText style={styles.cardPositionLabel}>
                          {index === 0 ? 'ê³¼ê±°' : index === 1 ? 'í˜„ì¬' : 'ë¯¸ë˜'}
                        </CustomText>
                      </View>
                    ))}
                  </View>
                </View>
              )}
              
              {/* Interpretation Area (Phase 5: Interpretation) */}
              {gamePhase === 'interpretation' && (
                <View style={styles.interpretationContainer}>
                  {/* Show cards (revealed) at top */}
                  <View style={styles.interpretationCardsContainer}>
                    {selectedCards.map((card, index) => (
                      <View key={card.id} style={styles.interpretationCardWrapper}>
                        <TarotCard
                          card={card}
                          isFront={true}
                          isSelected={false}
                          disabled={true}
                        />
                        <CustomText style={styles.cardPositionLabelSmall}>
                          {index === 0 ? 'ê³¼ê±°' : index === 1 ? 'í˜„ì¬' : 'ë¯¸ë˜'}
                        </CustomText>
                      </View>
                    ))}
                  </View>
                  
                  {/* Interpretation messages (scrollable) */}
                  <ScrollView
                    style={styles.interpretationMessagesContainer}
                    contentContainerStyle={styles.interpretationMessagesContent}
                    keyboardShouldPersistTaps="handled"
                  >
                    {isLoading && (
                      <View style={styles.loadingContainer}>
                        <CustomText style={styles.loadingText}>
                          ğŸ”® {persona?.persona_name || 'íƒ€ë¡œ ë§ˆìŠ¤í„°'}ê°€ ì¹´ë“œë¥¼ í•´ì„í•˜ê³  ìˆì–´ìš”...
                        </CustomText>
                      </View>
                    )}
                    
                    {messages.map((message) => (
                      <View
                        key={message.id}
                        style={[
                          styles.messageBubble,
                          message.type === 'user' ? styles.userBubble : styles.aiBubble
                        ]}
                      >
                        <CustomText style={styles.messageText}>
                          {message.text}
                        </CustomText>
                      </View>
                    ))}
                  </ScrollView>
                </View>
              )}
            </View>
            </TouchableWithoutFeedback>
            
            {/* âœ… Input Bar (Always visible for conversation) */}
            <RNAnimated.View 
              style={[
                styles.inputContainer,
                // âœ¨ 4. keyboardHeight ê°’ì„ marginBottomìœ¼ë¡œ ì—°ê²°í•©ë‹ˆë‹¤!
                { marginBottom: refFirstLoad.current ? Platform.OS === 'ios' ? 0 : -50 : keyboardHeight }
              ]}
            >

              <TarotInputBar
                onSend={handleSend}
                disabled={isLoading}
                placeholder={
                  gamePhase === 'greeting' || gamePhase === 'question'
                    ? "ë¬´ì—‡ì´ ê¶ê¸ˆí•œê°€ìš”?"
                    : gamePhase === 'selection'
                    ? "ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..."
                    : "íƒ€ë¡œ ê²°ê³¼ì— ëŒ€í•´ ì´ì•¼ê¸°í•´ë´ìš”"
                }
                persona={persona}
                currentEmotion="curious"
                // Disable features
                onImageSelect={null}
                onSettingsPress={null}
                onCreateMusic={null}
                onCreateMessage={null}
                visionMode={false}
                hasSelectedImage={false}
              />
            </RNAnimated.View>
          </View>
        </View>
      </View>

    </Modal>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },

  contentWrapper: {
    flex: 1,
  },

  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Background (NO OVERLAY - Persona Shines! âœ¨)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  background: {
    position: 'absolute',
    top: 0,
    left: 0,
    right: 0,
    bottom: 0,
    width: SCREEN_WIDTH,
    height: SCREEN_HEIGHT,
    backgroundColor: 'black',

  },
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Content (Respects Safe Area)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  keyboardAvoid: {
    flex: 1,
  },
  
  content: {
    flex: 1,
    zIndex: 10,
  },
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Header (Below System Area)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingHorizontal: platformPadding(16),
    paddingVertical: platformPadding(12),
    borderBottomWidth: 1,
    borderBottomColor: 'rgba(59, 130, 246, 0.2)',
    backgroundColor: COLORS.DEEP_BLUE_DARK,
    marginTop: Platform.OS === 'ios' ? 0 : -32,
  },
  
  backButton: {
    width: scale(40),
    height: scale(40),
    alignItems: 'center',
    justifyContent: 'center',
  },
  
  headerCenter: {
    flex: 1,
    alignItems: 'center',
    justifyContent: 'center',
    marginHorizontal: scale(10),
  },
  
  headerTitle: {
    fontSize: moderateScale(18),
    color: '#FFF',
    textShadowColor: 'rgba(0, 0, 0, 0.5)',
    textShadowOffset: { width: 0, height: 1 },
    textShadowRadius: 3,
  },
  
  helpButton: {
    width: scale(40),
    height: scale(40),
    alignItems: 'center',
    justifyContent: 'center',
  },
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Main Content Area (Takes remaining space)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  mainContentArea: {
    flex: 1,
  },
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Messages Area
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  messagesContainer: {
    flex: 1,
  },
  
  messagesContent: {
    padding: scale(20),
    flexGrow: 1,
    justifyContent: 'flex-end', // Messages stick to bottom
  },
  
  messageBubble: {
    maxWidth: '80%',
    padding: scale(12),
    borderRadius: moderateScale(15),
    marginBottom: verticalScale(10),
  },
  
  aiBubble: {
    alignSelf: 'flex-start',
    backgroundColor: 'rgba(179, 157, 219, 0.9)', // Purple (Tarot theme)
    borderBottomLeftRadius: moderateScale(5),
  },
  
  userBubble: {
    alignSelf: 'flex-end',
    backgroundColor: 'rgba(66, 133, 244, 0.9)', // Blue
    borderBottomRightRadius: moderateScale(5),
  },
  
  messageText: {
    fontSize: moderateScale(15),
    color: '#FFF',
    lineHeight: moderateScale(20),
  },
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Input Container
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  inputContainer: {
    paddingHorizontal: platformPadding(0),
    paddingTop: platformPadding(10),

  },
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Card Selection Area (Phase 3)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  cardSelectionContainer: {
    flex: 1,
    paddingHorizontal: scale(15),
    paddingVertical: verticalScale(20),
  },
  
  instructionsContainer: {
    alignItems: 'center',
    marginBottom: verticalScale(20),
    backgroundColor: 'rgba(123, 31, 162, 0.3)',
    paddingVertical: verticalScale(12),
    paddingHorizontal: scale(20),
    borderRadius: moderateScale(15),
    borderWidth: 1,
    borderColor: 'rgba(255, 215, 0, 0.5)',
  },
  
  instructionsText: {
    fontSize: moderateScale(16),
    color: '#FFF',
    textAlign: 'center',
    textShadowColor: 'rgba(0, 0, 0, 0.7)',
    textShadowOffset: { width: 0, height: 1 },
    textShadowRadius: 3,
  },
  
  instructionsSubtext: {
    fontSize: moderateScale(14),
    color: '#FFD700',
    textAlign: 'center',
    marginTop: verticalScale(5),
  },
  
  cardGrid: {
    flexGrow: 1,
    justifyContent: 'center',
    paddingVertical: verticalScale(10),
    paddingHorizontal: scale(10), // âœ¨ ì–‘ì˜† ì—¬ë°± ì¶”ê°€
  },
  
  cardWrapper: {
    width: '33.333%', // âœ¨ 3 columns (3x3 layout)
    padding: scale(6), // âœ¨ íŒ¨ë”© ì•½ê°„ ì¦ê°€ (ë” í¬ê²Œ!)
  },
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Card Select Button (Phase 2)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  cardSelectButtonContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
  
  cardSelectButton: {
    backgroundColor: 'rgba(123, 31, 162, 0.9)',
    paddingVertical: verticalScale(10),
    paddingHorizontal: scale(40),
    borderRadius: moderateScale(30),
    borderWidth: 2,
    borderColor: '#FFD700',
    // Glow effect
    shadowColor: '#FFD700',
    shadowOffset: { width: 0, height: 0 },
    shadowOpacity: 0.8,
    shadowRadius: 15,
    elevation: 10,
  },
  
  cardSelectButtonText: {
    fontSize: moderateScale(16),
    color: '#FFF',
    textShadowColor: 'rgba(0, 0, 0, 0.5)',
    textShadowOffset: { width: 0, height: 1 },
    textShadowRadius: 3,
  },
  
  confirmButton: {
    backgroundColor: 'rgba(255, 215, 0, 0.9)',
    paddingVertical: verticalScale(15),
    paddingHorizontal: scale(30),
    borderRadius: moderateScale(25),
    alignItems: 'center',
    justifyContent: 'center',
    marginTop: verticalScale(20),
    borderWidth: 2,
    borderColor: '#FFD700',
    // Glow effect
    shadowColor: '#FFD700',
    shadowOffset: { width: 0, height: 0 },
    shadowOpacity: 0.8,
    shadowRadius: 10,
    elevation: 10,
  },
  
  confirmButtonDisabled: {
    backgroundColor: 'rgba(128, 128, 128, 0.5)',
    borderColor: 'rgba(255, 255, 255, 0.3)',
    shadowOpacity: 0,
  },
  
  confirmButtonText: {
    fontSize: moderateScale(16),
    color: '#4A148C',
  },
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Card Reveal Area (Phase 4)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  revealContainer: {
    flex: 1,
    paddingHorizontal: scale(15),
    paddingVertical: verticalScale(20),
    justifyContent: 'center',
  },
  
  revealTitleContainer: {
    alignItems: 'center',
    marginBottom: verticalScale(30),
  },
  
  revealTitle: {
    fontSize: moderateScale(24),
    color: '#FFD700',
    textAlign: 'center',
    textShadowColor: 'rgba(0, 0, 0, 0.7)',
    textShadowOffset: { width: 0, height: 2 },
    textShadowRadius: 4,
  },
  
  revealSubtitle: {
    fontSize: moderateScale(14),
    color: '#FFF',
    textAlign: 'center',
    marginTop: verticalScale(8),
    opacity: 0.8,
  },
  
  revealCardsContainer: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    alignItems: 'center',
    paddingHorizontal: scale(10),
  },
  
  revealCardWrapper: {
    width: '30%',
    alignItems: 'center',
  },
  
  cardPositionLabel: {
    fontSize: moderateScale(12),
    color: '#FFD700',
    textAlign: 'center',
    marginTop: verticalScale(10),
    fontWeight: 'bold',
    textShadowColor: 'rgba(0, 0, 0, 0.7)',
    textShadowOffset: { width: 0, height: 1 },
    textShadowRadius: 3,
  },
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // Interpretation Area (Phase 5)
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  interpretationContainer: {
    flex: 1,
  },
  
  interpretationCardsContainer: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    alignItems: 'center',
    paddingHorizontal: scale(10),
    paddingVertical: verticalScale(15),
    backgroundColor: 'rgba(0, 0, 0, 0.3)',
    borderBottomWidth: 1,
    borderBottomColor: 'rgba(255, 215, 0, 0.3)',

  },
  
  interpretationCardWrapper: {
    width: '30%',
    alignItems: 'center',
  },
  
  cardPositionLabelSmall: {
    fontSize: moderateScale(10),
    color: '#FFD700',
    textAlign: 'center',
    marginTop: verticalScale(5),
    fontWeight: 'bold',
  },
  
  interpretationMessagesContainer: {
    flex: 1,
  },
  
  interpretationMessagesContent: {
    padding: scale(20),
    flexGrow: 1,
  },
  
  loadingContainer: {
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: verticalScale(30),
  },
  
  loadingText: {
    fontSize: moderateScale(14),
    color: '#B39DDB',
    textAlign: 'center',
    fontStyle: 'italic',
  },
});

export default TarotGameView;
